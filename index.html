<!doctype html>
<html lang = "en">
   <head>
      <meta charset = "utf-8">
      <link rel="icon" href="favicon.png" type="image/x-icon">
      <title>Code Player</title>
	  <link rel="stylesheet" type="text/css" href="style.css">
      <link href = "https://code.jquery.com/ui/1.10.4/themes/ui-lightness/jquery-ui.css" rel = "stylesheet">
      <script src = "https://code.jquery.com/jquery-1.10.2.js"></script>
      <script src = "https://code.jquery.com/ui/1.10.4/jquery-ui.js"></script>
      <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.58.3/codemirror.min.css">
      <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.58.3/codemirror.min.js"></script>
      <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.58.3/mode/htmlmixed/htmlmixed.min.js"></script>
      <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.58.3/mode/css/css.min.js"></script>
      <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.58.3/theme/dracula.css">
      <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.58.3/mode/javascript/javascript.min.js"></script>
	</head>
	<body>
        <script>
            $(document).ready(function()  {
                var htmlEditor = CodeMirror.fromTextArea(document.getElementById("rb-html-panel"), {
                    mode: "htmlmixed", // Set the initial mode (e.g., HTML)
                    lineNumbers: true, // Enable line numbers (optional)
                    theme: "dracula", 
                    
                });
    
                var cssEditor = CodeMirror.fromTextArea(document.getElementById("rb-css-panel"), {
                    mode: "css", // Set the initial mode (e.g., HTML)
                    lineNumbers: true, // Enable line numbers (optional)
                    theme: "dracula", // Choose a theme (optional)
                });
                var javascriptEditor = CodeMirror.fromTextArea(document.getElementById("rb-javascript-panel"), {
                    mode: "javascript", // Set the initial mode (e.g., HTML)
                    lineNumbers: true, // Enable line numbers (optional)
                    theme: "dracula", // Choose a theme (optional)
                });
                var implementJS = false;
                var compiledJSCode = "";
                var outputBlock = document.getElementById("rb-output-panel");
                var consoleBlock = document.getElementById("rb-console-panel");
    
                // Function to update the output on output panel
                function updateOutput() {
                    $("iframe").contents().find("html").html("<html><head><style type='text/css'>" + cssEditor.getValue() + "</style></head><body>" + htmlEditor.getValue() + "</body></html>");
                    if(implementJS){
                        document.getElementById("rb-output-panel").contentWindow.eval(javascriptEditor.getValue());
                        compiledJSCode = javascriptEditor.getValue();
                        implementJS = false;
                    }
                    else if(compiledJSCode){
                        document.getElementById("rb-output-panel").contentWindow.eval(compiledJSCode);
                    }
                    var scrollableDiv = $('#console');
                    scrollableDiv.scrollTop(scrollableDiv.prop('scrollHeight'));
                }
                
                // updating output
                updateOutput();
                
                function runCode() {
                    try {
                        updateOutput();

                        // Get user code from the textareas
                        var htmlCode = htmlEditor.getValue();
                        var cssCode = cssEditor.getValue();
                        var jsCode = javascriptEditor.getValue();

                        // Create an iframe to isolate the execution environment
                        var iframe = document.createElement('iframe');
                        iframe.style.display = 'none';

                        // Set up the load event listener for the iframe
                        iframe.onload = function () {
                            try {

                                iframe.contentWindow.console.log = function (message) {
                                    if (typeof message === 'object') {
                                        logMessage("Log", JSON.stringify(message));
                                    } else {
                                        logMessage("Log", message);
                                    }
                                };

                                // Write the HTML and CSS code into the iframe
                                iframe.contentDocument.write('<style>' + cssCode + '</style>');
                                iframe.contentDocument.write(htmlCode);

                                // Create a script element for JS code
                                var script = iframe.contentDocument.createElement('script');
                                script.text = jsCode;

                                // Append the script element to the iframe's document
                                iframe.contentDocument.body.appendChild(script);

                                // Remove the iframe after a short delay to allow for async code execution
                                setTimeout(function () {
                                    document.body.removeChild(iframe);
                                }, 100);
                            } catch (error) {
                                if (error.message){
                                    logError(error.message);
                                }
                            }
                        }
                        document.body.appendChild(iframe);
                    }
                     catch (error) {
                        if (error.message){
                            logError(error.message);
                        }
                    }
                    
                }

                // Function to log messages
                function logMessage(type, message) {
                    var consoleDiv = document.getElementById('rb-js-console-block');
                    consoleDiv.innerHTML += `<div class="rb-row-flex rb-console-logs rb-justify-start rb-gap-6 ${type === "Log" ? 'rb-text-seal-blue rb-console-log-msg' : 'rb-text-red rb-console-err-msg'}" >
                        ${(type === "Log") ? '<div class="rb-console-msg-pill rb-text-dark rb-text-center">&#8505;</div>' : '<div class="rb-console-err-pill rb-text-dark rb-text-center">&#9760;</div>'}
                        <div>${message}</div>
                        </div>`;
                }

                // Function to log errors
                function logError(error) {
                    logMessage("Error", error);
                }

                // function to hide/show display
                function showDisplay(type, value) {
                    const logList = document.querySelectorAll('.rb-console-'+type+'-msg');
                    if (logList){
                        logList.forEach(function(element) {
                            element.style.display = value;
                        });
                    }
                }

                $("#rb-run-btn").click(function() {
                    implementJS = true;
                    runCode();
                });

                // to clear console messages
                $("#rb-console-clear-btn").click(function() {
                    const consoleBlock = document.getElementById("rb-js-console-block");
                    if (consoleBlock) consoleBlock.innerHTML = ""; 
                });

                // to filter errors
                $("#rb-console-show-err").click(function() {
                    showDisplay('log', 'none');
                    showDisplay('err', 'flex');
                });

                // to filter info logs
                $("#rb-console-show-log").click(function() {
                    showDisplay('log', 'flex');
                    showDisplay('err', 'none');
                });

                // to show all logs
                $("#rb-console-show-all").click(function() {
                    showDisplay('log', 'flex');
                    showDisplay('err', 'flex');
                });

                //full screen
                $("#rb-console-fullscreen").click(function() {
                    if(outputBlock) outputBlock.style.height = '21vh';
                    if(consoleBlock) consoleBlock.style.height = '75.5vh';
                    document.getElementById("rb-console-fullscreen").style.display = 'none';
                    document.getElementById("rb-console-minimize").style.display = 'inline';
                });

                // minimize screen
                $("#rb-console-minimize").click(function() {
                    if(outputBlock) outputBlock.style.height = '81vh';
                    if(consoleBlock) consoleBlock.style.height = '16vh';
                    document.getElementById("rb-console-fullscreen").style.display = 'inline';
                    document.getElementById("rb-console-minimize").style.display = 'none';
                });
                
            });       
        </script>
            
            <!-- Panels for the rb-code-editor-btn-grps on the Header Above -->
        <div class="rb-row-flex rb-col-100">
            <div class="rb-col-49 rb-code-lang-block rb-ht-vh-100">
                <div>
                    <p class="rb-bg-dark rb-text-orange rb-col-100 rb-text-center rb-mr-bot-0 rb-mr-top-0 rb-text-bold rb-pad-5-0">HTML</p>
                    <textarea id="rb-html-panel" class="rb-html-css-panel rb-code-editor-panel"><div id="demo">Hello World!</div></textarea>
                </div>
                <div>
                    <p class="rb-bg-dark rb-text-orange rb-col-100 rb-text-center rb-mr-bot-0 rb-mr-top-0 rb-text-bold rb-pad-5-0">CSS</p>
                    <textarea id="rb-css-panel" class="rb-html-css-panel rb-code-editor-panel">html {background: #282a36;}
    div { color: red; }
                    </textarea>
                </div>
                <div>
                    <p class="rb-bg-dark rb-text-orange rb-col-100 rb-text-center rb-mr-bot-0 rb-mr-top-0 rb-text-bold rb-pad-5-0">JavaScript</p>
                    <textarea id="rb-javascript-panel" class="rb-code-editor-panel">document.getElementById("demo").innerHTML = "wellcome!";</textarea>
                </div>
            </div>
            <div class="rb-col-49 rb-ht-vh-100 rb-pos-rel">
                <p class="rb-bg-dark rb-text-orange rb-col-100 rb-text-center rb-mr-bot-0 rb-mr-top-0 rb-text-bold rb-pad-5-0 rb-pos-rel"><button id="rb-run-btn" class="rb-pos-abs rb-cur-pointer rb-top-2 rb-left-8">&#x1f3c3; Run</button> Output</p>
                <iframe id="rb-output-panel" class="rb-ht-vh-100 rb-col-100 rb-border-none rb-bg-white rb-ht-vh-81"></iframe>
                <div id="rb-console-panel" class="rb-col-100 rb-js-console">
                    <div class="rb-col-100 rb-row-flex rb-bg-dark rb-justify-between rb-text-orange rb-col-100 rb-text-center rb-mr-bot-0 rb-mr-top-0 rb-text-bold rb-pad-5-0 rb-pos-sticky rb-top-0 rb-line-ht-22">
                        <div class="rb-wdt-60">
                            Console
                        </div> 
                        <div class="rb-wdt-150 rb-text-right rb-pad-rt-8">
                            <span id="rb-console-show-all" class="rb-font-18 rb-text-seal-blue rb-mr-left-5 rb-cur-pointer" title="All Logs">&#10560;</span>
                            <span id="rb-console-show-log" class="rb-font-18 rb-text-green rb-mr-left-5 rb-cur-pointer" title="Filter Info">&#8505;</span>
                            <span id="rb-console-show-err" class="rb-font-18 rb-text-red rb-mr-left-5 rb-cur-pointer" title="Filter Error">&#9760;</span>
                            <span id="rb-console-fullscreen" class="rb-font-14 rb-text-orange rb-mr-left-5 rb-cur-pointer" title="Fullscreen">&#8689;</span>
                            <span id="rb-console-minimize" class="rb-font-14 rb-text-orange rb-mr-left-5 rb-cur-pointer rb-disp-none" title="Minimize">&#8690;</span>
                            <span id="rb-console-clear-btn" class="rb-text-white rb-mr-left-5 rb-cur-pointer" title="Clear Logs">Clear</span>
                        </div>
                    </div>
                    <div class="rb-text-seal-blue rb-log-bg rb-font-14" style="padding-left:5px;"><span>&#9786;</span> <span class="rb-text-green">Editor Initialized</span></div>
                    <div id="rb-js-console-block" class="rb-col-100"></div>
                </div>
            </div>
        </div>
	
	</body>
</html>	